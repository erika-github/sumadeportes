<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendario de Eventos - Enero 2025</title>
  <link rel="stylesheet" type="text/css" href="css/calendario_inscripcion_eventos.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />
  <!--<style>
    * {

      
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
  
      }

      ::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 10px;
      }


      ::-webkit-scrollbar-thumb {
        background: lightgray;       
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #0056b3;
      }
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
    }

    .calendar-panel {
      width: auto;
      height: 100vh;
      overflow-y: auto;
      background-color: white;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
      padding-right: 20px;
      padding-left: 5px;
      padding-top: 10px;
      position: sticky;
      top: 0;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      text-align: center;
      width: 100%;
    }

    .day-header {
      font-weight: bold;
      padding: 5px;
      box-sizing: border-box;
      background-color: lightgray;
    }

    .day {
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      cursor: pointer;
      box-sizing: border-box;
      position: relative;
      transition: background-color 0.3s, transform 0.3s;
    }

    .day.has-event:hover {
      background-color: #e9f7ef;
      transform: scale(1.1);
    }

    .event {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
    }

    .planned {
      background-color: lightgreen;
    }

    .finished {
      background-color: lightgray;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      position: absolute;
      top: 5px;
      left: 7px;
    }

    .otherEvents {
      background-color: white;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      position: absolute;
      top: 5px;
      left: 35px;
      border: 1px solid black;
    }

    .selected {
      background-color: green;
    }

    .events-container {
      padding-left: 20px;
      padding-right: 20px;
      margin-right: 5px;
      flex-grow: 1;
      text-align: center;
      overflow-y: auto;
    }

    .hidden {
      display: none;
    }

    .dataTables_wrapper {
      margin-bottom: 20px;
    }

    .dataTables_wrapper .dataTables_length {
      margin-bottom: 15px;
    }

    table {
      margin: 20px auto;
      width: 90%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }

    .legend {
      margin-top: 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
    }

    
    .legend .circle {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
      vertical-align: middle;
    }

    .legend .planned-circle {
      background-color: lightgreen;
    }

    .legend .finished-circle {
      background-color: lightgray;
    }

    .legend .otherEvents-circle {
      background-color: white;
      border: 1px solid black;
    }

    .button-blue {
      background-color: #012edc;
      color: white;
      padding: 10px;
      border: none;
      cursor: pointer;
      margin: 10px;
    }

    .button-orange {
      background-color: #f5754c;
      color: white;
      padding: 10px;
      border: none;
      cursor: pointer;
      margin: 10px;
    }

    .user-container {
      display: flex;
      justify-content: space-between;
      height: auto;
      margin-left: 2%;
      cursor: pointer;
    }

    .user-icon {
      width: 4vw;
      height: 4vw;
      background-color: #f36621;
      color: white;
      font-size: 1.5vw;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      cursor: pointer;
    }

    #img,
    .user-container p {
      position: absolute;
      top: 0px;
      width: auto;
      z-index: 100;
      margin-top: 0.5%;
      box-sizing: border-box;
      right: 5%;
    }

    #user-icon {
      position: absolute;
      top: 0px;
      z-index: 100;
      margin-top: 0.7%;
      box-sizing: border-box;
      right: 5%;
    }

    .user-menu {
      display: none;
      position: absolute;
      right: 1%;
      min-width: 13%;
      max-width: 13%;
      top: 5.4vw;
      background-color: white;
      border-radius: 0.5vw;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
      padding-bottom: 1%;
      z-index: 10000;
    }

    .user-menu-header {
      background-color: #f2f2f2;
      padding: 1.5vw;
      color: #7f7f7f;
      text-align: center;
      font-weight: lighter;
    }

    .user-menu-content {
      padding: 1vw;
      display: flex;
      flex-direction: column;
    }

    .user-menu-content a {
      text-decoration: none;
      color: #7f7f7f;
      padding: 0.7vw;
      text-align: center;
      border-radius: 0.3vw;
      margin-top: 2%;
      transition: background 0.3s ease;
    }

    .user-menu-content a:hover {
      background: #f2f2f2;
    }
  </style>-->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
</head>

<body>
  <div class="header-container">
   
    <div style="height: 7vw; position: relative">
      <img id="cintillo" src="img/cintilloMenu.png" alt="Cintillo" />
    </div>

    <div class="logoDiv">
      <img id="logo" src="img/logo.png" alt="Logo" onclick="window.location.href='index_autenticado.html'" />
    </div>
    
    <div class="user-container">
      <p style="
            font-size: 1.2vw;
            margin-top: 2%;
            right:27%;
            color: #1535d6;
            text-decoration: underline;
          " onclick="window.location.href='gestion.html'">
        Gestión
      </p>
      <p style="
            font-size: 1.2vw;
            margin-top: 2%;
            right:10%;
            color: #1535d6;
            text-decoration: underline;
          " onclick="window.location.href='inscripcion_eventos_mes.html'">
        Incripción a Eventos por Mes
      </p>

      <div id="user-icon" class="user-icon" onclick="toggleUserMenu()"></div>
    </div>
  </div>

  
  <div class="user-menu" id="user-menu">
    <div class="user-menu-header">
      <p style="font-size: 1vw" id="userName">Nombre del Usuario</p>
      <p style="font-size: 1vw" id="userRole">Rol del Usuario</p>
    </div>
    <div class="user-menu-content">
      <a href="#" style="font-size: 1vw">Editar Perfil</a>
      <a href="#" style="font-size: 1vw" onclick="logout()">Cerrar Sesión</a>
    </div>
  </div>

  <div style="display: flex; height: 100vh">
    <div class="calendar-panel">
      <h1 style="text-align: center; font-size: 24px">
        Calendario de Eventos
      </h1>
      <h2 style="text-align: center; margin-bottom: 50px" id="mes"></h2>
      <div class="calendar" id="calendar">
        <div class="day-header">D</div>
        <div class="day-header">L</div>
        <div class="day-header">M</div>
        <div class="day-header">M</div>
        <div class="day-header">J</div>
        <div class="day-header">V</div>
        <div class="day-header">S</div>
      </div>

      <div class="legend">
        <div style="margin-top: 30px; font-size: 13px">
          <div>
            <span class="circle planned-circle"></span>Eventos Programados
          </div>
          <div class="eventsCategory"></div>
          <div class="clickable" id="planned-Events" style="
                color: blue;
                cursor: pointer;
                text-decoration: underline;
                margin-top: 5px;
              ">
            ver todos
            <i id="eyeIcon-1" class="fas fa-eye-slash" style="color: #f5754c"></i>
          </div>
        </div>

        <div style="margin-top: 30px; font-size: 13px">
          <div>
            <span class="circle finished-circle"></span>Eventos Finalizados
          </div>
          <div class="eventsCategory"></div>
          <div class="clickable" id="showFinished" style="
                color: blue;
                cursor: pointer;
                text-decoration: underline;
                margin-top: 5px;
              ">
            ver todos
            <i id="eyeIcon-2" class="fas fa-eye-slash" style="color: #f5754c"></i>
          </div>
        </div>

        <div style="margin-top: 30px; font-size: 13px">
          <div>
            <span class="circle otherEvents-circle"></span>Eventos Programados
            y Finalizados
          </div>
          <div>(Otras Categorías)</div>
          <div class="clickable" id="showOtherEvents" style="
                color: blue;
                cursor: pointer;
                text-decoration: underline;
                margin-top: 5px;
              ">
            ver todos
            <i id="eyeIcon-3" class="fas fa-eye-slash" style="color: #f5754c"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="events-container">
      <div style="" class="student-info">
        <div style="
              margin: 2vh auto; /* Margen vertical adaptable */
              width: 25vw; /* Ancho relativo al viewport */
              min-width: 20vw; /* Evita que sea demasiado pequeño */
              max-width: 25vw; /* Evita que sea demasiado grande */
              display: flex;
              flex-direction: column;
              justify-content: center;
              /*align-items: center;*/
              border: 0.1vw solid #ccc; /* Borde adaptable */
              background-color: #f9f9f9;
              padding: 1.5vw; /* Espaciado interno relativo */
              border-radius: 0.5vw; /* Bordes redondeados proporcionales */
              box-shadow: 0.5vw 0.5vw 1vw rgba(0, 0, 0, 0.1); /* Sombra adaptable */
              font-size: 0.95vw; /* Tamaño de texto relativo */
            ">
          <h2 style="margin-bottom: 2%">Datos del Nadador</h2>
          <div style="text-align: start" id="cedula"></div>
          <div style="text-align: start" id="nombre"></div>
          <div style="text-align: start" id="apellido"></div>
          <div style="text-align: start" id="sexo"></div>
          <div style="text-align: start" id="edad"></div>
          <div style="text-align: start" id="fechaNac"></div>
        </div>
      </div>
      <h2 style="margin-top: 50px" id="calendarEventsTitle">
        Eventos Programados Seleccionados en el Calendario
        <i class="fas fa-arrow-up" style="color: blue; cursor: pointer; margin-left: 10px" onclick="scrollToTop()"></i>
        <br /><span class="eventsCategory"></span>
      </h2>
      <table id="eventTable" class="display">
        <thead>
          <tr>
            <th style="width: 50px">#</th>
            <th>Fecha</th>
            <th>Torneo</th>
            <th>Evento</th>
            <th style="width: 50px">Tiempo</th>
            <th style="width: 50px">Seleccionar</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="clearEvents" class="button-blue">Borrar Eventos</button>
      <button id="registerEvent" class="button-orange">
        Inscribirse en Evento
      </button>

      <div id="plannedEventsTableContainer" class="hidden">
        <h2 id="plannedEventsTitle" style="margin-top: 150px">
          Listado de Todos los
          <span style="color: orangered">Eventos Programados </span>
          <i class="fas fa-arrow-up" style="color: blue; cursor: pointer; margin-left: 10px"
            onclick="scrollToTop()"></i>
          <br /><span class="eventsCategory"></span>
        </h2>

        <table id="plannedEventsTable" class="display">
          <thead>
            <tr>
              <th>#</th>
              <th>Fecha</th>
              <th>Torneo</th>
              <th>Evento</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="finishedEventsTableContainer" class="hidden">
        <h2 id="finishedEventsTitle" style="margin-top: 150px">
          Listado de Todos los
          <span style="color: orangered">Eventos Finalizados </span>
          <i class="fas fa-arrow-up" style="color: blue; cursor: pointer; margin-left: 10px"
            onclick="scrollToTop()"></i>
          <br /><span class="eventsCategory"></span>
        </h2>

        <table id="finishedEventsTable" class="display">
          <thead>
            <tr>
              <th>#</th>
              <th>Fecha</th>
              <th>Torneo</th>
              <th>Evento</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="otherEventsTableContainer" class="hidden">
        <h2 id="otherEventsTitle" style="margin-top: 150px">
          Listado de Todos los
          <span style="color: orangered">Eventos Programados y Finalizados
          </span>
          <i class="fas fa-arrow-up" style="color: blue; cursor: pointer; margin-left: 10px"
            onclick="scrollToTop()"></i>
          <br />
          (Otras Categorías)
        </h2>

        <table id="otherEventsTable" class="display">
          <thead>
            <tr>
              <th>#</th>
              <th>Fecha</th>
              <th>Torneo</th>
              <th>Evento</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <script src="js/calendario_inscripcion_eventos.js"></script>
  <!--<script>
    
   
    let selectedDates = [];
    let events = {};
    let finishedEvents = [];
    let otherEvents = [];
    let eventId = 1;
    let dataTableInstance;
    let data;
    let plannedEvents_ = [];
    const parametros = obtenerParametrosURL();
    sessionStorage.setItem("month", parametros.mes);
    sessionStorage.setItem("year", parametros.anio);
    const resultado = infoMes(parametros.mes, parametros.anio);
    let age;
    let gender;
    let genderMap;
    let eventos = [];
    let result = {};
    let month;
    let firstLetterGender;
    let dayFormatted;

    const Mes = document.getElementById("mes");
    Mes.innerText = `${resultado.mesNombre} - ${resultado.anio}`;


   
    function logout() {
      sessionStorage.clear(); 
      window.location.href = "index.html"; 
    }

    
    function getInitials(firstName, lastName) {
      if (!firstName || !lastName) return "U"; 
      return (
        firstName.charAt(0).toUpperCase() + lastName.charAt(0).toUpperCase()
      );
    }

    
    function updateUserInfo() {
      
      const firstName = sessionStorage.getItem("userFirstName") || "Nombre";
      const lastName = sessionStorage.getItem("userLastName") || "Apellido";
      const userRole =
        sessionStorage.getItem("userRole") || "Rol Predeterminado";

      
      const fullName = `${firstName} ${lastName}`;

      const nameElem = document.getElementById("userName");
      const roleElem = document.getElementById("userRole");

      if (nameElem) nameElem.innerText = fullName;
      if (roleElem) roleElem.innerText = userRole;
    }

    
    function setUserIcon() {
      
      updateUserInfo();

    
      const firstName = sessionStorage.getItem("userFirstName");
      const lastName = sessionStorage.getItem("userLastName");

      
      const userIcon = document.getElementById("user-icon");
      if (userIcon) {
        userIcon.textContent = getInitials(firstName, lastName);
      }
    }

    
    function toggleUserMenu() {
      const menu = document.getElementById("user-menu");
      const userIcon = document.getElementById("user-icon");

      if (menu) {
        const isVisible = menu.style.display === "block";
        menu.style.display = isVisible ? "none" : "block";
        userIcon.style.backgroundColor = isVisible ? "#F36621" : "#2e3192";
      }
    }

    
    document.addEventListener("click", (event) => {
      const menu = document.getElementById("user-menu");
      const userIcon = document.getElementById("user-icon");
      const userContainer = document.querySelector(".user-container");

      if (
        menu &&
        userIcon &&
        userContainer &&
        !userContainer.contains(event.target)
      ) {
        menu.style.display = "none";
        userIcon.style.backgroundColor = "#F36621";
      }
    });

    document.addEventListener("change", async function (event) {
      
      if (event.target.classList.contains("inscribeCheckbox")) {

        const checkbox = event.target;
        
        const row = checkbox.closest("tr");
        
        const data = $("#eventTable").DataTable().row($(row)).data();

        const { documentType, documentNumber } = obtenerCedulaInfo("cedula");

        
        const eventData = {
          swimmerId: {
            documentType: documentType,
            documentNumber: documentNumber,
          },
          testDescription:
            data[3] || "Evento no encontrado",
        };


       
        if (checkbox.checked) {
          try {
            
            const response = await fetch(
              "https://c986-44-201-249-73.ngrok-free.app/mark/getMark",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(eventData),
              }
            );
            const responseData = await response.json();

            if (responseData.code === "200") {
              row.cells[4].textContent = responseData.data;
            } else {
              await Swal.fire({
                title: "Error",
                text:
                  responseData.message || "No se pudo actualizar el tiempo.",
                icon: "error",
                confirmButtonText: "Intentar nuevamente",
                allowOutsideClick: false,
                allowEscapeKey: false,
              });
            }
          } catch (error) {
            console.error("Error al llamar el servicio:", error);
            Swal.fire({
              title: "Error",
              text: error.message || "No se pudo conectar con el servidor.",
              icon: "error",
              confirmButtonText: "Intentar nuevamente",
              allowOutsideClick: false,
              allowEscapeKey: false,
            });
          }
        } else {
         
          console.log(
            "Checkbox desmarcado. No se realiza la llamada al servicio."
          );

          row.cells[4].textContent = "00:00:00";
        }
      }
    });


    function convertirFecha(fecha) {
      const partes = fecha.split("/");
      return `${partes[2]}-${partes[1]}-${partes[0]}`; 
    }

    //*//
    function obtenerEventosSeleccionados() {
      const eventosSeleccionados = [];
      var table = $("#eventTable").DataTable();
    
      const checkboxes = document.querySelectorAll(
        "#eventTable .inscribeCheckbox:checked"
      );

      checkboxes.forEach((checkbox) => {
        
        const row = checkbox.closest("tr");

        const data = table.row(row).data();
        
        const tiempo = row.cells[4].textContent.trim();

        const fechas = data[1].split(" al ");
        const startDate = convertirFecha(fechas[0].trim());
        const endDate = convertirFecha(fechas[1].trim());

        eventosSeleccionados.push({

          tournamentName: data[2],
          startDate: startDate,
          endDate: endDate,
          eventName: data[3],
          mark: tiempo,
        });
      });

      return eventosSeleccionados;
    }

    function obtenerCedulaInfo(labelId) {
     
      const cedulaText = document.getElementById(labelId).innerText;

      const cedulaValue = cedulaText.replace("Cédula:", "").trim();

      const partes = cedulaValue.split("-");

      const documentType = partes[0];

      const documentNumber = partes.slice(1).join("-");

      return { documentType, documentNumber };
    }

    document
      .getElementById("registerEvent")
      .addEventListener("click", async function () {
        const submitButton = document.getElementById("registerEvent");
        eventos = obtenerEventosSeleccionados();
       
        if (eventos.length === 0) {
          await Swal.fire({
            title: "Advertencia",
            text: "Debe seleccionar al menos un evento para continuar.",
            icon: "warning",
            confirmButtonText: "Aceptar",
            allowOutsideClick: false,
            allowEscapeKey: false,
          });
          return; 
        }

        const { documentType, documentNumber } = obtenerCedulaInfo("cedula");

        const requestData = {
          swimmerDocumentType: documentType,
          swimmerDocumentNumber: documentNumber,
          eventsMarks: eventos,
        };

        

        try {
      
          const response = await fetch(
            "https://c986-44-201-249-73.ngrok-free.app/eventsregister/create",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(requestData),
            }
          );

          const responseData = await response.json();

          if (responseData.code === "201") {
          
            const pagoPendiente = await Swal.fire({
              title: "Inscripción registrada",
              text: "El nadador se ha inscrito correctamente. ¿Desea registrar su pago ahora?",
              icon: "success",
              showCancelButton: true,
              confirmButtonText: "Sí",
              cancelButtonText: "No",
              confirmButtonColor: "#007bff",
              cancelButtonColor: "#d6d6d6",
              allowOutsideClick: false,
              allowEscapeKey: false,
              backdrop: true
            });

            if (pagoPendiente.isConfirmed) {
           
              window.location.href = "registro_pago_inscripcion.html";
            } else {
   
              const masInscripciones = await Swal.fire({
                title: "Pago pendiente",
                text: "Su inscripción fue exitosa. Sin embargo, queda pendiente el registro de su pago. ¿Desea realizar más inscripciones?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Sí",
                cancelButtonText: "No",
                confirmButtonColor: "#007bff",
                cancelButtonColor: "#d6d6d6",
                allowOutsideClick: false,
                allowEscapeKey: false,
                backdrop: true
              });

              if (masInscripciones.isConfirmed) {
                //
              } else {
               
                window.location.href = "gestion.html";
              }
            }
          } else if (responseData.code === "409") {
          
            await Swal.fire({
              title: "Advertencia",
              text: "El nadador ya se encuentra registrado en uno o más eventos seleccionados",
              icon: "warning",
              confirmButtonText: "Intentar nuevamente",
              confirmButtonColor: "#007bff",
              allowOutsideClick: false,
              allowEscapeKey: false,
              backdrop: true
            });

          } else {
            throw new Error(responseData.message || "Error al registrar el evento.");
          }
        } catch (error) {
          console.error("Error:", error);
          await Swal.fire({
            title: "Error",
            text: error.message || "No se pudo conectar con el servidor.",
            icon: "error",
            confirmButtonText: "Intentar nuevamente",
            confirmButtonColor: "#007bff",
            allowOutsideClick: false,
            allowEscapeKey: false,
            backdrop: true
          });
        } finally {
          submitButton.disabled = false;
        }
      });




    async function getOtherEventsCategories(age, gender, resultado) {


      const requestData = {
        month: resultado.mes || "",
        gender: gender.charAt(0) || "",
        age: age
      };


      try {
        
        const response = await fetch(
          "https://c986-44-201-249-73.ngrok-free.app/events/outOfCategory",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
          }
        );
        const result = await response.json(); 

        if (result.code === "200" && result.data) {

          otherEvents = result.data || [];

        } else {
          console.error("Error en la respuesta:", result);
        }
      } catch (error) {
        console.error("Error en la solicitud:", error.message);
      }

    }


    async function getFinishedEvents(age, gender, resultado) {


      const requestData = {
        month: resultado.mes || "",
        gender: gender.charAt(0) || "",
        age: age
      };


      try {
        
        const response = await fetch(
          "https://c986-44-201-249-73.ngrok-free.app/events/finished",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
          }
        );
        const result = await response.json(); 

        if (result.code === "200" && result.data) {

          finishedEvents = result.data || [];

        } else {
          console.error("Error en la respuesta:", result);
        }
      } catch (error) {
        console.error("Error en la solicitud:", error.message);
      }

    }

    
    async function getEventsByDate(age, gender, resultado) {


      const requestData = {
        month: resultado.mes || "",
        gender: gender.charAt(0) || "",
        age: age
      };

      try {
        const response = await fetch("https://c986-44-201-249-73.ngrok-free.app/events/programmed", {
          
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(requestData),
        });

        result = await response.json();

      
        if (result.code === "200" && Array.isArray(result.data)) {
          let elements = document.getElementsByClassName("eventsCategory");

          for (let elem of elements) {
            elem.innerHTML = `Dentro de la Categoría: ${age} Años, ${genderMap[gender]}`;
          }

          result.data.forEach((ev) => {
            const day = ev.startDate;
            if (!events[day]) {
              events[day] = [];
            }

            ev.eventName.forEach((name, index) => {
              events[day].push({
                eventName: name,
                startDate: ev.startDate,
                endDate: ev.endDate?.[index] || ev.endDate || ev.startDate, 
                tournamentName: ev.tournamentName?.[index] || "", 
              });
            });
          });

          plannedEvents_ = result.data || [];

        } else {
          console.error("Error en la respuesta:", result);
        }
      } catch (error) {
        console.error("Error en la solicitud:", error.message);
      }
    }

    
    async function searchSwimmer() {
      const requestData = {
        documentType: sessionStorage.getItem("userTypeDoc") || "",
        documentNumber: sessionStorage.getItem("userDoc") || "",
      };

      

      try {
      
        const response = await fetch(
          "https://c986-44-201-249-73.ngrok-free.app/swimmer/getById",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
          }
        );
        const result = await response.json(); 

        if (result.code === "200" && result.data) {
          
          genderMap = {
            male: "Masculino",
            female: "Femenino",
            OTHER: "Otro",
          };

          
          function formatDate(isoDate) {
            if (!isoDate) return "Fecha no disponible";
            const [year, month, day] = isoDate.split("-");
            return `${day}/${month}/${year}`;
          }

          let age = result.data.age;
          let gender = result.data.gender;
          document.getElementById(
            "cedula"
          ).innerHTML = `<strong>Cédula:</strong> ${result.data.swimmerId.documentType}-${result.data.swimmerId.documentNumber}`;
          document.getElementById(
            "nombre"
          ).innerHTML = `<strong>Nombre:</strong> ${result.data.firstName}`;
          document.getElementById(
            "apellido"
          ).innerHTML = `<strong>Apellido:</strong> ${result.data.firstSurename}`;
          document.getElementById(
            "sexo"
          ).innerHTML = `<strong>Género:</strong> ${genderMap[result.data.gender] || "No especificado"
          }`;
          document.getElementById(
            "edad"
          ).innerHTML = `<strong>Edad:</strong> ${result.data.age}`;
          document.getElementById(
            "fechaNac"
          ).innerHTML = `<strong>Fecha de Nacimiento:</strong> ${formatDate(
            result.data.birthDate
          )}`;

          await Promise.all([
            getEventsByDate(age, gender, resultado),
            getFinishedEvents(age, gender, resultado),
            getOtherEventsCategories(age, gender, resultado),
          ]);

          createCalendar(resultado.dias, resultado.primerDiaNumero);

        } else {
          console.error("Error: Respuesta inesperada del servicio", result);
        }
      } catch (error) {
        console.error("Error al obtener los datos del nadador:", error);
      }


    }

  
    function obtenerParametrosURL() {
      const params = new URLSearchParams(window.location.search);
      return {
        mes: params.get("mes"),
        anio: params.get("anio"),
      };
    }


    function infoMes(mesParametro, anioParametro) {

      const mes = parseInt(mesParametro, 10);

      if (isNaN(mes) || mes < 1 || mes > 12) {
        return {
          error: "El parámetro 'mes' debe ser un número entre 1 y 12.",
        };
      }


      const nombresMeses = [
        "Enero",
        "Febrero",
        "Marzo",
        "Abril",
        "Mayo",
        "Junio",
        "Julio",
        "Agosto",
        "Septiembre",
        "Octubre",
        "Noviembre",
        "Diciembre",
      ];

    
      const primerDiaFecha = new Date(anioParametro, mes - 1, 1);
      const primerDia = primerDiaFecha.getDay();

    
      const diasEnMes = new Date(anioParametro, mes, 0).getDate();
     
      const diasSemana = [
        "Domingo",
        "Lunes",
        "Martes",
        "Miércoles",
        "Jueves",
        "Viernes",
        "Sábado",
      ];

      return {
        anio: anioParametro,
        mes: mes,
        mesNombre: nombresMeses[mes - 1],
        dias: diasEnMes,
        primerDiaNumero: primerDia,
        primerDiaNombre: diasSemana[primerDia],
      };
    }

    function createCalendar(dias, primerDia) {
      const calendar = document.getElementById("calendar");
      const daysOfWeek = ["D", "L", "M", "M", "J", "V", "S"];
      const startDay = primerDia; 
      const daysInMonth = dias;
      calendar.innerHTML = "";
      
      daysOfWeek.forEach((day) => {
        const dayElement = document.createElement("div");
        dayElement.classList.add("day-header");
        dayElement.textContent = day;
        calendar.appendChild(dayElement);
      });

      for (let i = 0; i < startDay; i++) {
        const emptyCell = document.createElement("div");
        calendar.appendChild(emptyCell);
      }

      for (let i = 1; i <= daysInMonth; i++) {
        let day = document.createElement("div");
        day.classList.add("day");
        day.textContent = i;

     
        if (events[i]) {
          day.classList.add("has-event");
          const eventIndicator = document.createElement("div");
          eventIndicator.classList.add("event", "planned");
          day.appendChild(eventIndicator);
          day.addEventListener("click", () => selectEvent(i, events[i]));
        }


        if (finishedEvents.some(event => event.startDate === i)) {
          let finishedEventIndicator = document.createElement("div");
          finishedEventIndicator.classList.add("event", "finished");
          day.appendChild(finishedEventIndicator);
        }
               
        if (otherEvents.some(event => event.startDate === i)) {
          let otherEventsIndicator = document.createElement("div");
          otherEventsIndicator.classList.add("event", "otherEvents");
          day.appendChild(otherEventsIndicator);
        }


        calendar.appendChild(day);
      }
    }

    
    function selectEvent(day, event) {
      let index = selectedDates.indexOf(day);

      const dayElement = document
        .querySelectorAll(".day")
      [day - 1]?.querySelector(".event");
      
      if (!dayElement) return;
      dayElement.classList.add("planned");

      if (index === -1) {
        
        selectedDates.push(day);
        dayElement.classList.add("selected"); 
      } else {
        
        selectedDates.splice(index, 1);
        dayElement.classList.remove("selected"); 

        const table = $("#eventTable").DataTable();

        const dayFormattedStart = `${day.toString().padStart(2, "0")}/${resultado.mes
          .toString()
          .padStart(2, "0")}/${resultado.anio}`;


        const rowIndexes = table
          .rows()
          .indexes()
          .toArray()
          .filter((index) => {
            const rowData = table.row(index).data();
            const fechaInicioEnTabla = rowData[1]?.split(" al ")[0];
            return fechaInicioEnTabla === dayFormattedStart;
          });

        for (let i = rowIndexes.length - 1; i >= 0; i--) {
          table.row(rowIndexes[i]).remove();
        }

        if (rowIndexes.length > 0) {
          table.draw(false); 
        }
      }

      updateTable();
      reorganizeIndexes();
    }

    function updateTable() {
      let table = $("#eventTable").DataTable();
      let existingData = table.rows().data().toArray(); 

      selectedDates.forEach((day) => {

        let eventDataList = plannedEvents_.filter((item) => item.startDate === day);

        if (eventDataList.length > 0) {


          eventDataList.forEach((eventData) => {
           
            eventData.eventName.forEach((eventName, index) => {

              let tournamentsName = eventData.tournamentName[index] || "";
              
              let isExisting = existingData.some((row) => {

                return (
                  row[1] ===

                  `${day.toString().padStart(2, "0")}/${resultado.mes
                    .toString()
                    .padStart(2, "0")}/${resultado.anio} al ${eventData.endDate
                      .toString()
                      .padStart(2, "0")}/${resultado.mes
                        .toString()
                        .padStart(2, "0")}/${resultado.anio}` &&
                  row[2] === tournamentsName &&
                  row[3] === eventName
                );
              });

              if (!isExisting) {
        
                const createDropdown = (name, options) => {
                  return `
                  <div class="custom-dropdown">
                    <div class="dropdown-selected" data-type="${name}" data-id="${eventId}">00</div>
                    <div class="dropdown-options">
                      ${options
                      .map(
                        (option) =>
                          `<div class="dropdown-option" onclick="selectOption(${eventId}, '${name}', ${option})">${option < 10 ? "0" + option : option
                          }</div>`
                      )
                      .join("")}
                    </div>
                  </div>
                `;
                };

                table.row
                  .add([
                    eventId++,
                    `${day.toString().padStart(2, "0")}/${resultado.mes
                      .toString()
                      .padStart(2, "0")}/${resultado.anio} al ${eventData.endDate
                        .toString()
                        .padStart(2, "0")}/${resultado.mes
                          .toString()
                          .padStart(2, "0")}/${resultado.anio}`,
                    tournamentsName,
                    eventName, 

                    `<span class="time" data-id="${eventId - 1
                    }">00:00:00</span>`, 
                    `<input type="checkbox" class="inscribeCheckbox" data-index="${index}" style="display: block; margin: 0 auto;">`,
                    `<i class="fas fa-trash-alt" style="color: blue; cursor: pointer; display: block; margin: 0 auto;"></i>`,
                  ])
                  .draw(false);
              }
            });

          });
        }
      });
    }



    function getTimeValues(eventName) {
      return {
        minutes: "00",
        seconds: "00",
        centiseconds: "00",
        time: "00:00:00",
      };
    }


    function scrollToTop() {
      const container = document.querySelector(".events-container"); 
      if (container) {
        container.scrollTo({ top: 0, behavior: "smooth" });
      }
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function scrollToBottom() {
      document.querySelectorAll(".events-container").forEach((container) => {
        container.scrollTo({
          top: container.scrollHeight,
          behavior: "smooth",
        });
      });
    }


    function obtenerEstadoEvento(endDate, mes, anio) {
      
      const endDateValue = Array.isArray(endDate) ? endDate[0] : endDate;

      const parsedEndDate = parseInt(endDateValue, 10);
      if (isNaN(parsedEndDate)) {
        console.warn("endDate no válido:", endDateValue);
        return "DESCONOCIDO";
      }

      const fechaFinEvento = new Date(anio, mes - 1, parsedEndDate);
      
      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);
     

      return fechaFinEvento >= hoy ? "PROGRAMADO" : "FINALIZADO";
    }

    $(document).ready(function () {
     
      dataTableInstance = $("#eventTable").DataTable({
        language: {
          search: "Buscar:",
          lengthMenu: "Mostrar _MENU_ entradas",
          infoEmpty: "Mostrando _TOTAL_ entradas",
          info: "Mostrando _START_ a _END_ de _TOTAL_ entradas",
          paginate: {
            first: "Primero",
            last: "Último",
            next: "Siguiente",
            previous: "Anterior",
          },
          emptyTable:
            "Seleccione alguno de los eventos programados en el calendario",
        },
      });

      let plannedTable = $("#plannedEventsTable").DataTable({
        language: {
          search: "Buscar:",
          lengthMenu: "Mostrar _MENU_ entradas",
          infoEmpty: "Mostrando _TOTAL_ entradas",
          info: "Mostrando _START_ a _END_ de _TOTAL_ entradas",
          paginate: {
            first: "Primero",
            last: "Último",
            next: "Siguiente",
            previous: "Anterior",
          },
          emptyTable: "No hay datos disponibles en la tabla",
        },
      });

      let otherEventsTable = $("#otherEventsTable").DataTable({
        language: {
          search: "Buscar:",
          lengthMenu: "Mostrar _MENU_ entradas",
          infoEmpty: "Mostrando _TOTAL_ entradas",
          info: "Mostrando _START_ a _END_ de _TOTAL_ entradas",
          paginate: {
            first: "Primero",
            last: "Último",
            next: "Siguiente",
            previous: "Anterior",
          },
          emptyTable: "No hay datos disponibles en la tabla",
        },
      });

      let finishedTable = $("#finishedEventsTable").DataTable({
        language: {
          search: "Buscar:",
          lengthMenu: "Mostrar _MENU_ entradas",
          infoEmpty: "Mostrando _TOTAL_ entradas",
          info: "Mostrando _START_ a _END_ de _TOTAL_ entradas",
          paginate: {
            first: "Primero",
            last: "Último",
            next: "Siguiente",
            previous: "Anterior",
          },
          emptyTable: "No hay datos disponibles en la tabla",
        },
      });

      $("#eventTable tbody").on("click", ".fa-trash-alt", function () {
        const table = $("#eventTable").DataTable();
        let row = table.row($(this).parents("tr"));
        let rowData = row.data();

        let date = parseInt(rowData[1].split("/")[0]); 

        
        let remainingRows = table
          .rows()
          .data()
          .toArray()
          .filter((data) => parseInt(data[1].split("/")[0]) === date);

        
        row.remove().draw();

    
        if (remainingRows.length === 1) {
          let dayElement = document
            .querySelectorAll(".day")
          [date - 1]?.querySelector(".event");
          if (dayElement) {
            dayElement.classList.remove("selected");
            selectedDates = [];
          }
        }

        reorganizeIndexes();
      });

      $("#clearEvents").on("click", function () {
        const table = $("#eventTable").DataTable();
        table.clear().draw();
        selectedDates = [];
        createCalendar(resultado.dias, resultado.primerDiaNumero);
        eventId = 1;
      });

      $("#planned-Events").on("click", function () {
        let idCounter = 1;
        let plannedEventsTable = $("#plannedEventsTable").DataTable();
        plannedEventsTable.clear().draw(); 

        
        $("#eyeIcon-1").toggleClass("fa-eye fa-eye-slash");
        $("#eyeIcon-1").css(
          "color",
          $("#eyeIcon-1").hasClass("fa-eye") ? "#012EDC" : "#f5754C"
        );

        plannedEvents_.forEach((event) => {
          event.eventName.forEach((eventName, index) => {

            let status = "PROGRAMADO" || "";
            let tournamentsName = event.tournamentName[index] || "";

            plannedEventsTable.row
              .add([
                idCounter++,                
                `${event.startDate.toString().padStart(2, "0")}/${resultado.mes
                  .toString()
                  .padStart(2, "0")}/${resultado.anio} al ${event.endDate
                    .toString()
                    .padStart(2, "0")}/${resultado.mes
                      .toString()
                      .padStart(2, "0")}/${resultado.anio}`,
                tournamentsName,
                eventName, 
                status, 
              ])
              .draw(false);
          });
        });
        $("#plannedEventsTableContainer").toggleClass("hidden");

       
        const plannedTitle = document.getElementById("plannedEventsTitle");
        if (plannedTitle) {
          plannedTitle.scrollIntoView({
            behavior: "smooth", 
            block: "start", 
          });
        }
      });

      $("#showFinished").on("click", function () {
        let idCounter = 1;
        let finishedTable = $("#finishedEventsTable").DataTable();

        finishedTable.clear().draw(); 

        
        $("#eyeIcon-2").toggleClass("fa-eye fa-eye-slash");
        $("#eyeIcon-2").css(
          "color",
          $("#eyeIcon-2").hasClass("fa-eye") ? "#012EDC" : "#f5754C"
        );

        finishedEvents.forEach((event) => {
          event.eventName.forEach((eventName, index) => {
            let tournamentsName = event.tournamentName[index] || "";
            let status = "FINALIZADO" || "";

            finishedTable.row
              .add([
                idCounter++,                
                `${event.startDate.toString().padStart(2, "0")}/${resultado.mes
                  .toString()
                  .padStart(2, "0")}/${resultado.anio} al ${event.endDate
                    .toString()
                    .padStart(2, "0")}/${resultado.mes
                      .toString()
                      .padStart(2, "0")}/${resultado.anio}`,
                tournamentsName,
                eventName, 
                status, 
              ])
              .draw(false);
          });
        });
        $("#finishedEventsTableContainer").toggleClass("hidden");
        
        const finishedTitle = document.getElementById("finishedEventsTitle");
        if (finishedTitle) {
          finishedTitle.scrollIntoView({
            behavior: "smooth", 
            block: "start", 
          });
        }
      });

      $("#showOtherEvents").on("click", function () {
        let idCounter = 1;
        let otherEventsTable = $("#otherEventsTable").DataTable();

        otherEventsTable.clear().draw(); 
        
        $("#eyeIcon-3").toggleClass("fa-eye fa-eye-slash");
        $("#eyeIcon-3").css(
          "color",
          $("#eyeIcon-3").hasClass("fa-eye") ? "#012EDC" : "#f5754C"
        );

        otherEvents.forEach((event) => {
          event.eventName.forEach((eventName, index) => {

            let status = obtenerEstadoEvento(event.endDate, resultado.mes, resultado.anio); 
            let tournamentsName = event.tournamentName[index] || "";
            otherEventsTable.row
              .add([
                idCounter++,             
                `${event.startDate.toString().padStart(2, "0")}/${resultado.mes
                  .toString()
                  .padStart(2, "0")}/${resultado.anio} al ${event.endDate
                    .toString()
                    .padStart(2, "0")}/${resultado.mes
                      .toString()
                      .padStart(2, "0")}/${resultado.anio}`,
                tournamentsName,
                eventName, 
                status, 
              ])
              .draw(false);
          });
        });

        $("#otherEventsTableContainer").toggleClass("hidden");
        const otherEventsTitle = document.getElementById("otherEventsTitle");
        if (otherEventsTitle) {
          otherEventsTitle.scrollIntoView({
            behavior: "smooth", 
            block: "start", 
          });
        }
      });
    });

    function reorganizeIndexes() {
      let filas = document.querySelectorAll("#eventTable tbody tr");
      const table = $("#eventTable").DataTable();
    
      if (table.rows({ filter: "applied" }).data().length === 0) {
        const mensajeFila = document.createElement("tr");
        
        if (
          !document.querySelector(
            '#eventTable tbody tr[data-empty-message="true"]'
          )
        ) {
          mensajeFila.setAttribute("data-empty-message", "true");
          document
            .querySelector("#eventTable tbody")
            .appendChild(mensajeFila);
        }

        eventId = 1;
      } else {
        
        filas.forEach((fila, index) => {
          fila.cells[0].textContent = index + 1; 
        });
      }
    }

    setUserIcon();
    searchSwimmer();

  </script>-->
</body>

</html>