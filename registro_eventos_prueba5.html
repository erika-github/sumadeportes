<script>
    // Función para convertir fecha de nacimiento en formato "YYYY-mm-dd"
    function transformDate(birthDate) {
      let partes = birthDate.split("/");
      let birth_ = new Date(`${partes[2]}-${partes[1]}-${partes[0]}T00:00:00`);
      let year = birth_.getFullYear();
      let month = (birth_.getMonth() + 1).toString().padStart(2, "0");
      let day = birth_.getDate().toString().padStart(2, "0");
      return `${year}-${month}-${day}`;
    }
  
    // Función de validación por campo
    function validateField(id, label) {
      let valid = true;
      const errorField = document.getElementById("error" + id.charAt(0).toUpperCase() + id.slice(1));
  
      if (id === "events_container") {
        // Se valida que haya al menos un evento seleccionado
        if (selectedEvents.length === 0) {
          errorField.textContent = `Debes seleccionar al menos un ${label}.`;
          errorField.style.display = "block";
          valid = false;
        } else {
          errorField.textContent = "";
          errorField.style.display = "none";
        }
      } else {
        const field = document.getElementById(id);
        if (!field || field.value.trim() === "") {
          errorField.textContent = `${label} es requerido.`;
          errorField.style.display = "block";
          valid = false;
        } else {
          errorField.textContent = "";
          errorField.style.display = "none";
        }
      }
      return valid;
    }
  
    // Función para adjuntar validación en tiempo real a cada campo
    function attachRealTimeValidations() {
      const fieldLabels = {
        tournament: "Torneo",
        events_container: "Evento",
        startDate: "Fecha Inicio",
        endDate: "Fecha Fin"
      };
      Object.keys(fieldLabels).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener("input", function () {
            validateField(id, fieldLabels[id]);
          });
        }
      });
    }
  
    // Función para validar todos los campos antes de enviar el formulario
    function validateForm() {
      let valid = true;
      const fieldsToValidate = {
        tournament: "Torneo",
        events_container: "Evento",
        startDate: "Fecha Inicio",
        endDate: "Fecha Fin"
      };
      Object.entries(fieldsToValidate).forEach(([id, label]) => {
        if (!validateField(id, label)) {
          valid = false;
        }
      });
      return valid;
    }
  
    // Función para cargar los eventos y configurar el DataTable
    async function loadEvents() {
      try {
        const response = await fetch("http://localhost:8085/tests/getList");
        if (!response.ok) {
          throw new Error(`Error en la API: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        if (!data.data || !Array.isArray(data.data)) {
          throw new Error('La estructura de la respuesta no es válida.');
        }
        // Convertir cada cadena en un objeto y conservar la cadena original
        const teamsData = data.data.map((teamStr, index) => {
          const partes = teamStr.split(',').map(item => item.trim());
          return {
            id: index + 1,
            estilo: partes[0],
            edad: partes[1],
            genero: partes[2],
            original: teamStr
          };
        });
  
        // Inicializa el DataTable en el contenedor #events_table
        if ($.fn.DataTable.isDataTable('#events_table')) {
          $('#events_table').DataTable().destroy();
        }
        $('#events_table').DataTable({
          data: teamsData,
          columns: [
            { data: 'id', title: 'ID' },
            { data: 'estilo', title: 'Estilo' },
            { data: 'edad', title: 'Edad' },
            { data: 'genero', title: 'Género' },
            { 
              data: null, 
              title: 'Seleccionar', 
              orderable: false,
              render: function (data, type, row) {
                return `<input type="checkbox" class="event-checkbox" data-id="${row.id}">`;
              }
            }
          ],
          paging: true,
          searching: true,
          ordering: true,
          info: true,
          responsive: true,
          language: {
            search: "Buscar:",
            lengthMenu: "Mostrar _MENU_ registros",
            info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
            paginate: {
              previous: "Anterior",
              next: "Siguiente"
            }
          }
        });
  
        // Reiniciar el array de eventos seleccionados
        selectedEvents = [];
  
        // Manejo de la selección de checkboxes en el DataTable
        $('#events_table tbody').off('change').on('change', '.event-checkbox', function () {
          const table = $('#events_table').DataTable();
          const rowData = table.row($(this).closest('tr')).data();
          
          if (this.checked) {
            // Si no está agregado, se agrega el objeto completo
            if (!selectedEvents.find(event => event.id === rowData.id)) {
              selectedEvents.push(rowData);
            }
          } else {
            selectedEvents = selectedEvents.filter(event => event.id !== rowData.id);
          }
  
          // Validación del formulario en tiempo real
          validateField('events_container', 'Evento');
  
          console.log('Eventos seleccionados:', selectedEvents);
        });
  
      } catch (error) {
        console.error("Error al obtener los datos:", error);
      }
    }
  
    // Función para cargar los torneos en el select
    async function loadTournaments() {
      const tournamentSelect = document.getElementById("tournament");
      try {
        const response = await fetch("http://localhost:8085/tournament/getList", {
          method: "GET"
        });
        const data = await response.json();
        if (data.code === "200" && Array.isArray(data.data)) {
          data.data.forEach(tournament => {
            const option = document.createElement("option");
            option.value = tournament.tournamentName;
            option.textContent = tournament.tournamentName;
            tournamentSelect.appendChild(option);
          });
        } else {
          console.error("Error: Respuesta inesperada del servicio", data);
        }
      } catch (error) {
        console.error("Error al obtener los torneos:", error);
      }
    }
  
    // Inicialización cuando el DOM esté cargado
    document.addEventListener("DOMContentLoaded", function () {
      setUserIcon();
      loadTournaments();
      loadEvents();
      attachRealTimeValidations();
    });
  
    // Listener para el envío del formulario
    document.getElementById("form-swimmer").addEventListener("submit", async function (event) {
      event.preventDefault();
      if (!validateForm()) {
        Swal.fire({
          title: "Error",
          text: "Por favor, corrige los errores en el formulario.",
          icon: "error",
          confirmButtonText: "Entendido"
        });
        return;
      }
      submitButton.disabled = true;
      // Mapeamos selectedEvents para obtener un array de strings (la propiedad 'original')
      const eventsNames = selectedEvents.map(event => event.original);
      const requestData = {
        tournamentName: document.getElementById("tournament").value.trim(),
        eventsNames: eventsNames,
        startDate: document.getElementById("startDate").value,
        endDate: document.getElementById("endDate").value
      };
      try {
        const response = await fetch(" http://localhost:8085/events/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestData)
        });
        const responseData = await response.json();
        if (responseData.code === "201") {
          await Swal.fire({
            title: "Registro exitoso",
            text: "El evento ha sido registrado correctamente.",
            icon: "success",
            confirmButtonText: "Aceptar"
          });
          window.location.href = "gestion.html";
        } else if (responseData.code === "409") {
          await Swal.fire({
            title: "Error",
            text: "Ya existe un evento con ese nombre",
            icon: "error",
            confirmButtonText: "Intentar nuevamente"
          });
        } else {
          throw new Error(responseData.message || "Error al registrar el evento.");
        }
      } catch (error) {
        console.error("Error:", error);
        Swal.fire({
          title: "Error",
          text: error.message || "No se pudo conectar con el servidor.",
          icon: "error",
          confirmButtonText: "Intentar nuevamente"
        });
      } finally {
        submitButton.disabled = false;
      }
    });
  </script>
  </body>
  </html>
  